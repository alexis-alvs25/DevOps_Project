- name: List the contents of /home/debian
  hosts: servers
  vars_files:
    - vars/vars_app.yaml
  roles:
    - geerlingguy.docker          # Role to install Docker
  become: yes

  tasks:
    - name: Create a directory on the VM to contain Docker files
      ansible.builtin.file:
        path: /home/debian/docker
        state: directory

    - name: Copy local Docker files to the VM
      ansible.builtin.copy:
        src: ./../docker/{{ item }}
        dest: /home/debian/docker/{{ item }}
      with_items: "{{ app_packages }}"

      # Construction des images Docker

    - name: Log into private registry and force re-authorization
      docker_login:
        registry: ${DOCKER_REGISTRY_URL}
        username: ${DOCKER_REGISTRY_USER}
        password: ${DOCKER_REGISTRY_PASSWORD}
        reauthorize: yes

    - name: Build an image and push it to a private repo
      community.docker.docker_image:
        build:
          path: /home/debian/docker/
        name: ${DOCKER_REGISTRY_URL}/init_mariadb
        tag: v1
        push: true
        source: build

    - name: Deploy Docker Compose images
      community.docker.docker_compose_v2:
        project_src: /home/debian/docker/
        files:
          - docker-compose.yml
      register: output

    - name: Show results
      ansible.builtin.debug:
        var: output